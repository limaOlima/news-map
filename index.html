<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="jszip.min.js" type="text/javascript"></script>

<script src="https://www.amcharts.com/lib/4/core.js"></script>
<script src="https://www.amcharts.com/lib/4/maps.js"></script>
<script src="https://www.amcharts.com/lib/4/geodata/worldLow.js"></script>
<script src="https://www.amcharts.com/lib/4/geodata/usaLow.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


<link href="https://fonts.googleapis.com/css?family=Lacquer|Unica+One|Sulphur+Point&display=swap" rel="stylesheet">



<style>


body{
  background-color: #021017;
  font-family: 'Sulphur Point', sans-serif;
  color: #ffffff;
  /*font-family: 'Lacquer', sans-serif;
  font-family: Helvetica;
  font-family: 'Unica One', cursive;*/
}

.wrapper{
  position:relative;
}

#headingbox {
  position:absolute;
  top: 20;
  left:0;
  width: 100%;
}

#heading {
  width: 400px;
  margin-left:auto;
  margin-right:auto;
  text-align: center;
  font-size: 36px;
  text-transform: capitalize;
}

#chartdiv {
  width: 100%;
  /*height: 90%; /*600px;*/*/
  margin-top:10px;
  margin-left: auto;
  margin-right: auto;
  /*height: 70%;*/
  background-color: #021017;
}

#draggableTextbox {
  border: 1px solid #0076b3;
  position: absolute;
  bottom:0;
  left:0;
  width: 20%;
  height: 40%;
  overflow:scroll;
  margin-left: 8%;
  margin-bottom: 5%;
  padding: 0.5em;
  background-color: #021017;
}

.textboxInner {
  width: 90%;
  height: 90%;
  margin-left: auto;
  margin-right: auto;

}


.p {
  font-size: 24px;
}

#textbox a {
  font-size: 16px;
  color: #00cb7a;
  width: 380px;
}

a:visited {
  font-size: 24px;
  color: #00cb7a;
}


#draggableTextbox a {
  font-size: 16px;
  color: #00cb7a;
  width: 380px;
}

#draggableTextbox h1 {
  font-size: 24px;
}


</style>

<!-- Chart code -->
<script>



am4core.ready(function() {

// Themes begin
am4core.useTheme(am4themes_animated);
// Themes end

/**
 * Define SVG path for target icon
 */
var targetSVG2 = "M4,0 C6.209139,0 8,1.790861 8,4 C8,6.209139 6.209139,8 4,8 C1.790861,8 0,6.209139 0,4 C0,1.790861 1.790861,0 4,0 Z M4,1 C2.34314575,1 1,2.34314575 1,4 C1,5.65685425 2.34314575,7 4,7 C5.65685425,7 7,5.65685425 7,4 C7,2.34314575 5.65685425,1 4,1 Z";

//var targetSVG = "M9,0C4.029,0,0,4.029,0,9s4.029,9,9,9s9-4.029,9-9S13.971,0,9,0z M9,15.93 c-3.83,0-6.93-3.1-6.93-6.93S5.17,2.07,9,2.07s6.93,3.1,6.93,6.93S12.83,15.93,9,15.93 M12.5,9c0,1.933-1.567,3.5-3.5,3.5S5.5,10.933,5.5,9S7.067,5.5,9,5.5 S12.5,7.067,12.5,9z";

var targetSVG = "M165,185 C167,185 169,186 169,189 C169,191 167,193 165,193 C162,193 161,191 161,189 C161,186 162,185 165,185Z";


// Define colors
var targetColor = "#00cb7a";
var countryColorStroke = "#0076b3";
var countryColorMin = "#d90059";
var countryColorMax = "#110073";


// Create map instance
var chart = am4core.create("chartdiv", am4maps.MapChart);

// Set map definition
chart.geodata = am4geodata_worldLow;

// Set projection
chart.projection = new am4maps.projections.Miller();

// Create map polygon series
polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());

// Exclude Antartica
polygonSeries.exclude = ["AQ"];

// add heat legend
var heatLegend = chart.chartContainer.createChild(am4maps.HeatLegend);
heatLegend.valign = "middle";
heatLegend.align = "left";
heatLegend.width = am4core.percent(100);
heatLegend.height = am4core.percent(80);
heatLegend.series = polygonSeries;
heatLegend.orientation = "vertical";
heatLegend.padding(20, 20, 20, 20);
heatLegend.valueAxis.renderer.labels.template.fontSize = 10;
heatLegend.valueAxis.renderer.minGridDistance = 20;

// Make map load polygon (like country names) data from GeoJSON
polygonSeries.useGeodata = true;

// Configure series
var polygonTemplate = polygonSeries.mapPolygons.template;
polygonTemplate.strokeOpacity = 1;
polygonTemplate.nonScalingStroke = true;

/* ===== > BORDERS COUNTRIES*/
polygonTemplate.stroke = am4core.color(countryColorStroke);

/* ===== > COLORS COUNTRIES*/

// Heatmap
polygonSeries.heatRules.push({
  property: "fill",
  target: polygonSeries.mapPolygons.template,
  min: am4core.color(countryColorMin),
  max: am4core.color(countryColorMax)
});

polygonSeries.mapPolygons.template.events.on("over", event => {
  handleHover(event.target);
});

polygonSeries.mapPolygons.template.events.on("hit", event => {
  handleHover(event.target);
});

function handleHover(mapPolygon) {
  if (!isNaN(mapPolygon.dataItem.value)) {
    heatLegend.valueAxis.showTooltipAt(mapPolygon.dataItem.value);
  } else {
    heatLegend.valueAxis.hideTooltip();
  }
}

// create capital markers
imageSeries = chart.series.push(new am4maps.MapImageSeries());

/* ===== > MARKER*/


// define template
var imageSeriesTemplate = imageSeries.mapImages.template;
var circle = imageSeriesTemplate.createChild(am4core.Sprite);
var circle2 = imageSeriesTemplate.createChild(am4core.Sprite);

circle.scale = 2;
circle2.scale = 2;

//circle.fill = new am4core.InterfaceColorSet().getFor("alternativeBackground");
//circle.fill = am4core.color("#00cb7a");
circle.fill = am4core.color(targetColor);
circle.fillOpacity = 0.3;
circle2.fill = am4core.color(targetColor);
circle2.fillOpacity = 1;


//circle.reafFill = am4core.color("#FFFFFF");
circle.path = targetSVG;
circle2.path = targetSVG2;

//animations
circle.horizontalCenter = "middle";
circle.verticalCenter = "middle";

circle.showOnInit = true
circle.defaultState.transitionEasing = am4core.ease.expIn;
circle.defaultState.transitionDuration = 4000;
//circle.hiddenState.properties.dy = -300;

//circle2
circle2.horizontalCenter = "middle";
circle2.verticalCenter = "middle";

circle2.showOnInit = true
circle2.defaultState.transitionEasing = am4core.ease.expIn;
circle2.defaultState.transitionDuration = 4000;


// set propertyfields
imageSeriesTemplate.propertyFields.latitude = "latitude";
imageSeriesTemplate.propertyFields.longitude = "longitude";

imageSeriesTemplate.horizontalCenter = "middle";
imageSeriesTemplate.verticalCenter = "middle";
imageSeriesTemplate.align = "center";
imageSeriesTemplate.valign = "middle";
imageSeriesTemplate.width = 8;
imageSeriesTemplate.height = 8;
imageSeriesTemplate.nonScaling = true;
imageSeriesTemplate.tooltipText = "[bold]{location}[/]\n{title}";
imageSeriesTemplate.urlTarget  = "_blank";
imageSeriesTemplate.propertyFields.url = "url";
imageSeriesTemplate.fill = am4core.color("#000");
imageSeriesTemplate.background.fillOpacity = 0;
imageSeriesTemplate.background.fill = am4core.color("#ffffff");
imageSeriesTemplate.setStateOnChildren = true;
imageSeriesTemplate.states.create("hover");


polygonSeries.data = [
  { id: "AF", value: 70.524 },
  { id: "AL", value: 77.185 },
  { id: "DZ", value: 70.874 },
  { id: "AO", value: 51.498 },
  { id: "AR", value: 76.128 },
  { id: "AM", value: 74.469 },
  { id: "AU", value: 82.364 },
  { id: "AT", value: 80.965 },
  { id: "AZ", value: 70.686 },
  { id: "BH", value: 76.474 },
  { id: "BD", value: 70.258 },
  { id: "BY", value: 69.829 },
  { id: "BE", value: 80.373 },
  { id: "BJ", value: 59.165 },
  { id: "BT", value: 67.888 },
  { id: "BO", value: 66.969 },
  { id: "BA", value: 76.211 },
  { id: "BW", value: 47.152 },
  { id: "BR", value: 73.667 },
  { id: "BN", value: 78.35 },
  { id: "BG", value: 73.448 },
  { id: "BF", value: 55.932 },
  { id: "BI", value: 53.637 },
  { id: "KH", value: 71.577 },
  { id: "CM", value: 54.61 },
  { id: "CA", value: 81.323 },
  { id: "CV", value: 74.771 },
  { id: "CF", value: 49.517 },
  { id: "TD", value: 50.724 },
  { id: "CL", value: 79.691 },
  { id: "CN", value: 75.178 },
  { id: "CO", value: 73.835 },
  { id: "KM", value: 60.661 },
  { id: "CD", value: 49.643 },
  { id: "CG", value: 58.32 },
  { id: "CR", value: 79.712 },
  { id: "CI", value: 50.367 },
  { id: "HR", value: 76.881 },
  { id: "CU", value: 79.088 },
  { id: "CY", value: 79.674 },
  { id: "CZ", value: 77.552 },
  { id: "DK", value: 79.251 },
  { id: "GL", value: 79.251 },
  { id: "DJ", value: 61.319 },
  { id: "DO", value: 73.181 },
  { id: "EC", value: 76.195 },
  { id: "EG", value: 70.933 },
  { id: "SV", value: 72.361 },
  { id: "GQ", value: 52.562 },
  { id: "ER", value: 62.329 },
  { id: "EE", value: 74.335 },
  { id: "ET", value: 62.983 },
  { id: "FJ", value: 69.626 },
  { id: "FI", value: 80.362 },
  { id: "FR", value: 81.663 },
  { id: "GA", value: 63.115 },
  { id: "GF", value: 79.9 },
  { id: "GM", value: 58.59 },
  { id: "GE", value: 74.162 },
  { id: "DE", value: 80.578 },
  { id: "GH", value: 60.979 },
  { id: "GR", value: 80.593 },
  { id: "GT", value: 71.77 },
  { id: "GN", value: 55.865 },
  { id: "GW", value: 54.054 },
  { id: "GY", value: 66.134 },
  { id: "HT", value: 62.746 },
  { id: "HN", value: 73.503 },
  { id: "HK", value: 83.199 },
  { id: "HU", value: 74.491 },
  { id: "IS", value: 81.96 },
  { id: "IN", value: 66.168 },
  { id: "ID", value: 70.624 },
  { id: "IR", value: 73.736 },
  { id: "IQ", value: 69.181 },
  { id: "IE", value: 80.531 },
  { id: "IL", value: 81.641 },
  { id: "IT", value: 82.235 },
  { id: "JM", value: 73.338 },
  { id: "JP", value: 83.418 },
  { id: "JO", value: 73.7 },
  { id: "KZ", value: 66.394 },
  { id: "KE", value: 61.115 },
  { id: "KP", value: 69.701 },
  { id: "KR", value: 81.294 },
  { id: "KW", value: 74.186 },
  { id: "KG", value: 67.37 },
  { id: "LA", value: 67.865 },
  { id: "LV", value: 72.045 },
  { id: "LB", value: 79.716 },
  { id: "LS", value: 48.947 },
  { id: "LR", value: 60.23 },
  { id: "LY", value: 75.13 },
  { id: "LT", value: 71.942 },
  { id: "LU", value: 80.371 },
  { id: "MK", value: 75.041 },
  { id: "MG", value: 64.28 },
  { id: "MW", value: 54.798 },
  { id: "MY", value: 74.836 },
  { id: "ML", value: 54.622 },
  { id: "MR", value: 61.39 },
  { id: "MU", value: 73.453 },
  { id: "MX", value: 77.281 },
  { id: "MD", value: 68.779 },
  { id: "MN", value: 67.286 },
  { id: "ME", value: 74.715 },
  { id: "MA", value: 70.714 },
  { id: "EH", value: 70.714 },
  { id: "MZ", value: 49.91 },
  { id: "MM", value: 65.009 },
  { id: "NA", value: 64.014 },
  { id: "NP", value: 67.989 },
  { id: "NL", value: 80.906 },
  { id: "NZ", value: 80.982 },
  { id: "NI", value: 74.515 },
  { id: "NE", value: 57.934 },
  { id: "NG", value: 52.116 },
  { id: "NO", value: 81.367 },
  { id: "SJ", value: 81.367 },
  { id: "OM", value: 76.287 },
  { id: "PK", value: 66.42 },
  { id: "PA", value: 77.342 },
  { id: "PG", value: 62.288 },
  { id: "PY", value: 72.181 },
  { id: "PE", value: 74.525 },
  { id: "PH", value: 68.538 },
  { id: "PL", value: 76.239 },
  { id: "PT", value: 79.732 },
  { id: "QA", value: 78.231 },
  { id: "RO", value: 73.718 },
  { id: "RU", value: 67.874 },
  { id: "RW", value: 63.563 },
  { id: "SA", value: 75.264 },
  { id: "SN", value: 63.3 },
  { id: "RS", value: 73.934 },
  { id: "SL", value: 45.338 },
  { id: "SG", value: 82.155 },
  { id: "SK", value: 75.272 },
  { id: "SI", value: 79.444 },
  { id: "SB", value: 67.465 },
  { id: "SO", value: 54 },
  { id: "ZA", value: 56.271 },
  { id: "SS", value: 54.666 },
  { id: "ES", value: 81.958 },
  { id: "LK", value: 74.116 },
  { id: "SD", value: 61.875 },
  { id: "SR", value: 70.794 },
  { id: "SZ", value: 48.91 },
  { id: "SE", value: 81.69 },
  { id: "CH", value: 82.471 },
  { id: "SY", value: 71 },
  { id: "TW", value: 79.45 },
  { id: "TJ", value: 67.118 },
  { id: "TZ", value: 60.885 },
  { id: "TH", value: 74.225 },
  { id: "TL", value: 67.033 },
  { id: "TG", value: 56.198 },
  { id: "TT", value: 69.761 },
  { id: "TN", value: 75.632 },
  { id: "TR", value: 74.938 },
  { id: "TM", value: 65.299 },
  { id: "UG", value: 58.668 },
  { id: "UA", value: 68.414 },
  { id: "AE", value: 76.671 },
  { id: "GB", value: 80.396 },
  { id: "US", value: 78.797 },
  { id: "UY", value: 77.084 },
  { id: "UZ", value: 68.117 },
  { id: "VE", value: 74.477 },
  { id: "PS", value: 73.018 },
  { id: "VN", value: 75.793 },
  { id: "YE", value: 62.923 },
  { id: "ZM", value: 57.037 },
  { id: "ZW", value: 58.142 }
];

//imageSeries.data = data;
}); // end am4core.ready()


geoPoints = []
lastFile = "NONE";



maxPoints = 100

function howManyPointsDel(points) {
 d = points.length - maxPoints;
 if(d > 0) {
  return d;
 }
 return 0;
}

function updateMap() {
 if(geoPoints.length > 0) {
  geo = geoPoints.pop();
  imageSeries.addData(geo,howManyPointsDel(imageSeries.data));
 }
}


function getLastUpdate() {
	requestFile("http://data.gdeltproject.org/gdeltv2/lastupdate.txt", function (data) {
		files = []
		line = data.split("\n");
		line.forEach(function(n) {
			d = n.split(" ");
			files.push(d[2])
		});
		eventFile = files[0]
		if (lastFile != eventFile) {
			console.log(eventFile)
			lastFile = eventFile
			loadEvents(eventFile)
		}
	});
}

function loadEvents(url) {
	requestFile(url, function (data) {
				var zip = new JSZip();
				zip.loadAsync(data).then(function(contents) {
					Object.keys(contents.files).forEach(function(filename) {
						zip.file(filename).async('text').then(function(content) {
							file = content;
							events = file.split("\n");
							console.log("Load Events")
							events.forEach(function(n) {
								d = n.split("	");
								geoPoints.push({
										id : "ZW",
                    "location": d[44],
                    "title": d[60],
                    "url": d[60],
										"latitude": Number(d[40]),
										"longitude": Number(d[41]),
										value : 50
								});
							});
							console.log("Load Events Finished")
						});
					});
				});
			}, {
				responseType: 'blob'
			});
}

function requestFile(url, success, xhrFields) {
	$.ajax({
			url: 'https://cors-anywhere.herokuapp.com/' + url,
			method: 'GET',
			xhrFields: xhrFields,
			headers: {
			"x-requested-with": "xhr"
			},
			success: success
		});
}

$( function() {
  $( "#draggableTextbox" ).draggable();
} );


$( function() {
  $( "#textbox" ).draggable();
} );

getLastUpdate()
setInterval(getLastUpdate, 300000);

setInterval(updateMap, 1000);

</script>
</head>

<body>
    <div class="wrapper">
      <div id="chartdiv"></div>
      <div id="headingbox">
        <div id="heading">Was geht ab?</div>
      </div>

      <div id="draggableTextbox" class="ui-widget-content">
        <div class="textboxInner">
            <h1>Turnip greens yarrow ricebean rutabaga endive cauliflower</h1>
            <a href="https://www.der-postillon.com/" target="_blank">Zeitungsartikel öffnen</a>

            <p>Turnip greens yarrow ricebean rutabaga endive cauliflower sea
              lettuce kohlrabi amaranth water spinach avocado daikon napa cabbage
              asparagus winter purslane kale. Celery potato scallion desert raisin
              horseradish spinach carrot soko. Lotus root water spinach fennel kombu
              maize bamboo shoot green bean swiss chard seakale pumpkin onion
              chickpea gram corn pea.</p>
        </div>
      </div>

  </div>
</body>

</html>
